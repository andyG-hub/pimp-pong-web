<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pimp Pong | Leaderboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #0b0b0b; color: white; text-align: center; padding: 20px; }
        .container { max-width: 450px; margin: auto; background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333; }
        h1 { color: #ffd700; }
        input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        button { width: 95%; padding: 10px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-reg { background: #ffd700; color: black; }
        .btn-raid { background: #1da1f2; color: white; }
        #leaderboard { margin-top: 30px; text-align: left; }
        .entry { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; }
        .wallet { font-size: 0.7em; color: #777; }
    </style>
</head>
<body>

<div class="container">
    <h1>PIMP PONG ‚≠ê</h1>
    <input type="text" id="twitterHandle" placeholder="X Name (e.g. @PimpPong)">
    <input type="text" id="walletAddress" placeholder="Solana Wallet Address">
    <button class="btn-reg" onclick="registerUser()">JOIN LEADERBOARD</button>

    <div style="margin-top:20px; border-top: 1px solid #333; padding-top:20px;">
        <h3>ü•ö RAID</h3>
        <input type="text" id="tweetLink" placeholder="Tweet Link">
        <button class="btn-raid" onclick="submitRaid()">CLAIM EGG</button>
    </div>

    <div id="leaderboard">
        <h3>Leaderboard</h3>
        <div id="list">Loading...</div>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://advzccqwmbukvwdpnoef.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdnpjY3F3bWJ1a3Z3ZHBub2VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTcyMzcsImV4cCI6MjA1MzM5ODYyNn0.9oxdNG93FSeDkng-UXlV0G2XlauQeszW7HLadIuGvqQ";
    
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function fetchLeaderboard() {
        const { data, error } = await sb.from('gold_eggs_leaderboard').select('twitter_name, wallet_address, points').order('points', { ascending: false });
        if (error) { 
            console.error(error);
            document.getElementById('list').innerHTML = "Sync Error. Please check SQL."; 
            return; 
        }
        if (!data || data.length === 0) {
            document.getElementById('list').innerHTML = "No Pimps yet.";
            return;
        }
        document.getElementById('list').innerHTML = data.map(u => `
            <div class="entry">
                <div>
                    <div>${u.twitter_name}</div>
                    <div class="wallet">${u.wallet_address ? u.wallet_address.slice(0,4)+'...'+u.wallet_address.slice(-4) : 'No Wallet'}</div>
                </div>
                <div style="color:#ffd700">${u.points} ü•ö</div>
            </div>
        `).join('');
    }

    async function registerUser() {
        const twitter_name = document.getElementById('twitterHandle').value.trim();
        const wallet_address = document.getElementById('walletAddress').value.trim();
        if(!twitter_name || !wallet_address) return alert("Fill all fields!");
        const { error } = await sb.from('gold_eggs_leaderboard').insert([{ twitter_name, wallet_address, points: 0 }]);
        if (error) alert("Error: " + error.message); else fetchLeaderboard();
    }

    async function submitRaid() {
        const twitterName = document.getElementById('twitterHandle').value.trim();
        const tweetLink = document.getElementById('tweetLink').value.trim();
        const res = await fetch('/api/check-raids', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ twitterName, tweetLink })
        });
        const result = await res.json();
        if (result.success) { alert("Egg secured!"); fetchLeaderboard(); } else { alert(result.error); }
    }

    fetchLeaderboard();
</script>
</body>
</html>
